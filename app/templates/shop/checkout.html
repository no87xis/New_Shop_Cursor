{% extends "base.html" %}

{% block title %}Оформление заказа - Sirius Group V2{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">
            <i class="fas fa-credit-card mr-2"></i>Оформление заказа
        </h1>
        <p class="text-gray-600">
            Заполните данные для оформления заказа
        </p>
    </div>

    <form method="POST" action="/shop/checkout" class="space-y-8">
        <!-- Customer Information -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-user mr-2"></i>Данные покупателя
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-2">
                        ФИО *
                    </label>
                    <input type="text" 
                           id="customer_name" 
                           name="customer_name" 
                           required
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="customer_phone" class="block text-sm font-medium text-gray-700 mb-2">
                        Телефон *
                    </label>
                    <input type="tel" 
                           id="customer_phone" 
                           name="customer_phone" 
                           required
                           placeholder="+375 (29) 123-45-67"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label for="customer_city" class="block text-sm font-medium text-gray-700 mb-2">
                        Город
                    </label>
                    <input type="text" 
                           id="customer_city" 
                           name="customer_city"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- WhatsApp Information -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fab fa-whatsapp mr-2"></i>WhatsApp уведомления
            </h2>
            <div class="space-y-4">
                <div>
                    <label for="whatsapp_phone" class="block text-sm font-medium text-gray-700 mb-2">
                        WhatsApp номер
                    </label>
                    <input type="tel" 
                           id="whatsapp_phone" 
                           name="whatsapp_phone"
                           placeholder="+375 (29) 123-45-67"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-sm text-gray-500 mt-1">
                        Для получения уведомлений о готовности заказа
                    </p>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" 
                           id="consent_whatsapp" 
                           name="consent_whatsapp" 
                           value="true"
                           checked
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="consent_whatsapp" class="ml-2 block text-sm text-gray-700">
                        Согласен на получение уведомлений в WhatsApp
                    </label>
                </div>
            </div>
        </div>

        <!-- Delivery Options -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-truck mr-2"></i>Способ доставки
            </h2>
            <div class="space-y-3">
                {% for option in delivery_options %}
                <div class="flex items-center">
                    <input type="radio" 
                           id="delivery_{{ option.value }}" 
                           name="delivery_option" 
                           value="{{ option.value }}"
                           {% if loop.first %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                    <label for="delivery_{{ option.value }}" class="ml-3 block text-sm text-gray-700">
                        <span class="font-medium">{{ option.description }}</span>
                        {% if option.value != 'SELF_PICKUP_GROZNY' %}
                        <span class="text-gray-500">(300₽ × количество товаров)</span>
                        {% else %}
                        <span class="text-green-600 font-medium">(Бесплатно)</span>
                        {% endif %}
                    </label>
                </div>
                {% endfor %}
            </div>
            <div id="other-city-input" class="mt-4 hidden">
                <label for="delivery_city_other" class="block text-sm font-medium text-gray-700 mb-2">
                    Укажите город
                </label>
                <input type="text" 
                       id="delivery_city_other" 
                       name="delivery_city_other"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <!-- Order Summary -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-list mr-2"></i>Сводка заказа
            </h2>
            <div class="space-y-3">
                {% for item in cart.items %}
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <div>
                        <span class="font-medium">{{ item.product_name }}</span>
                        <span class="text-gray-500">× {{ item.quantity }}</span>
                    </div>
                    <span class="font-medium">{{ "%.2f"|format(item.total_price) }} ₽</span>
                </div>
                {% endfor %}
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span>Товары:</span>
                    <span>{{ "%.2f"|format(cart.total_amount) }} ₽</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span>Доставка:</span>
                    <span id="delivery-cost">0 ₽</span>
                </div>
                <div class="flex justify-between items-center py-2 text-lg font-bold">
                    <span>Итого:</span>
                    <span id="total-cost">{{ "%.2f"|format(cart.total_amount) }} ₽</span>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="flex space-x-4">
            <a href="/shop/cart" class="flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-200 transition duration-300 text-center">
                <i class="fas fa-arrow-left mr-2"></i>Назад к корзине
            </a>
            <button type="submit" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                <i class="fas fa-credit-card mr-2"></i>Оформить заказ
            </button>
        </div>
    </form>
</div>

<script>
// Обработка изменения способа доставки
document.addEventListener('DOMContentLoaded', function() {
    const deliveryOptions = document.querySelectorAll('input[name="delivery_option"]');
    const otherCityInput = document.getElementById('other-city-input');
    const deliveryCostElement = document.getElementById('delivery-cost');
    const totalCostElement = document.getElementById('total-cost');
    
    const cartTotal = {{ cart.total_amount }};
    const deliveryUnitPrice = 300;
    const totalItems = {{ cart.total_items }};

    function updateDeliveryCost() {
        const selectedOption = document.querySelector('input[name="delivery_option"]:checked');
        if (!selectedOption) return;

        let deliveryCost = 0;
        
        if (selectedOption.value === 'SELF_PICKUP_GROZNY') {
            deliveryCost = 0;
            otherCityInput.classList.add('hidden');
        } else {
            deliveryCost = deliveryUnitPrice * totalItems;
            if (selectedOption.value === 'COURIER_OTHER') {
                otherCityInput.classList.remove('hidden');
            } else {
                otherCityInput.classList.add('hidden');
            }
        }

        deliveryCostElement.textContent = deliveryCost + ' ₽';
        totalCostElement.textContent = (cartTotal + deliveryCost).toFixed(2) + ' ₽';
    }

    deliveryOptions.forEach(option => {
        option.addEventListener('change', updateDeliveryCost);
    });

    // Инициализация
    updateDeliveryCost();
});

// Валидация формы
document.querySelector('form').addEventListener('submit', function(e) {
    const customerName = document.getElementById('customer_name').value.trim();
    const customerPhone = document.getElementById('customer_phone').value.trim();
    const selectedDelivery = document.querySelector('input[name="delivery_option"]:checked');
    const otherCityInput = document.getElementById('delivery_city_other');

    if (!customerName) {
        e.preventDefault();
        alert('Пожалуйста, укажите ФИО');
        return;
    }

    if (!customerPhone) {
        e.preventDefault();
        alert('Пожалуйста, укажите телефон');
        return;
    }

    if (!selectedDelivery) {
        e.preventDefault();
        alert('Пожалуйста, выберите способ доставки');
        return;
    }

    if (selectedDelivery.value === 'COURIER_OTHER' && !otherCityInput.value.trim()) {
        e.preventDefault();
        alert('Пожалуйста, укажите город для доставки');
        return;
    }
});
</script>
{% endblock %}